#!/usr/bin/env python

"""hsc-vs-decals --clobber

Run the legacyhalos pipeline on the HSC vs DECaLS comparison sample.

import pickle
from legacyhalos.ellipse import ellipse_sbprofile
with open('cgcg004-096/cgcg004-096-ellipsefit.p', 'rb') as ff:
    res = pickle.load(ff)
prof = ellipse_sbprofile(res)            
with open('cgcg004-096/cgcg004-096-sbprofile.p', 'wb') as out:
    pickle.dump(prof, out)

"""
import os, argparse, sys, time
import pdb
import numpy as np
import matplotlib.pyplot as plt

import fitsio
from astropy.table import Table, hstack
from astrometry.util.fits import fits_table
from legacypipe.survey import LegacySurveyData

import legacyhalos.io
import legacyhalos.misc

def missing_files(sample, filedir='.', filetype='coadds',
                  size=1, clobber=False):
    """Find missing data of a given filetype."""    

    if filetype == 'coadds':
        filesuffix = 'pipeline-resid.jpg'
    elif filetype == 'custom_coadds':
        filesuffix = 'custom-resid.jpg'
    elif filetype == 'ellipse':
        filesuffix = 'ellipsefit.p'
    elif filetype == 'html':
        filesuffix = 'junk'
    else:
        print('Unrecognized file type!')
        raise ValueError

    ngal = len(sample)
    indices = np.arange(ngal)
    todo = np.ones(ngal, dtype=bool)

    for ii, onegal in enumerate(np.atleast_1d(sample)):
        galaxy = onegal['GALAXY'].decode('utf-8').lower()
        checkfile = os.path.join(filedir, galaxy, '{}-{}'.format(galaxy, filesuffix))
        if os.path.exists(checkfile) and clobber is False:
            todo[ii] = False

    if np.sum(todo) == 0:
        return list()
    else:
        indices = indices[todo]
        
    return np.array_split(indices, size)

def build_sample(clobber=False):
    """Build the parent sample for this project."""
    from astrometry.libkd.spherematch import match_radec

    samplefile = os.path.join( legacyhalos.io.hsc_vs_decals_dir(), 'hsc-vs-decals.fits' )
    if os.path.exists(samplefile) and clobber is False:
        print('Sample file {} exists; clobber?'.format(samplefile))
        return

    # Really should be reading this from disk.
    cat = Table()
    cat['GALAXY'] = np.array(['CGCG004-096'])
    cat['RA'] = np.array([129.603676]).astype('f8')
    cat['DEC'] = np.array([-1.606419]).astype('f8')
    cat['Z'] = np.array([0.05204]).astype('f4')
    cat['RADIUS'] = np.array([35.0]).astype('f4') # approximate "size", [arcsec]

    brickname = '1296m015' # hard-coded
    tractorfile = os.path.join(os.getenv('LEGACY_SURVEY_DIR'), 'tractor', brickname[:3],
                               'tractor-{}.fits'.format(brickname))
    print('Reading {}'.format(tractorfile))
    tractor = Table(fitsio.read(tractorfile, upper=True))
    m1, m2, _ = match_radec(tractor['RA'], tractor['DEC'], cat['RA'],
                            cat['DEC'], 1/3600, nearest=True)

    sample = hstack( (cat['GALAXY', 'Z'], tractor[m1]) )
    #sample.rename_column('GALAXY', 'CENTRAL_ID')

    print('Writing {}'.format(samplefile))
    sample.write(samplefile, overwrite=clobber)

    return sample

def main():

    import legacyhalos.io

    parser = argparse.ArgumentParser()
    parser.add_argument('--nproc', default=4, type=int, help='number of multiprocessing processes.')
    parser.add_argument('--pixscale', default=0.262, type=float, help='pixel scale (arcsec/pix).')

    parser.add_argument('--build-sample', action='store_true', help='Build and write out the sample.')
    parser.add_argument('--coadds', action='store_true', help='Build the pipeline coadds.')
    parser.add_argument('--custom-coadds', action='store_true', help='Build the custom coadds.')
    parser.add_argument('--ellipse', action='store_true', help='Do the ellipse fitting.')
    parser.add_argument('--html', action='store_true', help='Make plots for the webpage!')

    parser.add_argument('--force', action='store_true', help='Use with --coadds; ignore previous pickle files.')
    parser.add_argument('--count', action='store_true', help='Count how many objects are left to analyze and then return.')
    parser.add_argument('--debug', action='store_true', help='Log to STDOUT and build debugging plots.')
    parser.add_argument('--verbose', action='store_true', help='Be verbose!')
    parser.add_argument('--clobber', action='store_true', help='Overwrite existing files.')                                
    args = parser.parse_args()

    analysisdir = legacyhalos.io.hsc_vs_decals_dir()

    # Write out the sample.
    if args.build_sample:
        sample = build_sample(clobber=args.clobber)
        sys.exit(1)

    # Figure out what's left to do.
    sample = legacyhalos.io.read_hsc_vs_decals(verbose=args.verbose)
    
    groups, suffix = [], ''
    if args.coadds:
        suffix = 'coadds'
        groups = missing_files(sample, filedir=analysisdir, filetype=suffix, clobber=args.clobber)
    elif args.custom_coadds:
        suffix = 'custom_coadds'
        groups = missing_files(sample, filedir=analysisdir, filetype=suffix, clobber=args.clobber)
    elif args.ellipse:
        suffix = 'ellipse'
        groups = missing_files(sample, filedir=analysisdir, filetype=suffix, clobber=args.clobber)
    elif args.html:
        suffix = 'html'
        groups = missing_files(sample, filedir=analysisdir, filetype=suffix, clobber=args.clobber)
    else:
        groups = []

    if len(groups) == 0:
        ntodo = 0
    else:
        ntodo = len(np.hstack(np.atleast_1d(groups)))
        
    if ntodo == 0:
        print('{} for all {} galaxies are complete!'.format(
            suffix.upper(), len(sample)), flush=True)
        return
    else:
        print('{} left to do: {} / {} divided across {} group(s).'.format(
            suffix.upper(), ntodo, len(sample), len(groups)), flush=True)

    print('Starting {} {} at {}'.format(ntodo, suffix.upper(), time.asctime()), flush=True)
    
    # Generate the pipeline coadds.
    if args.coadds:
        from legacyhalos.coadds import pipeline_coadds
        survey = LegacySurveyData()

        for ii in groups:
            t0 = time.time()

            onegal = sample[ii][0]
            galaxy = onegal['GALAXY'].lower()
            survey.output_dir = os.path.join(analysisdir, galaxy)
            
            radius = legacyhalos.misc.cutout_radius_150kpc( 
                redshift=onegal['Z'], pixscale=args.pixscale) # [pixels]
            
            err = pipeline_coadds(onegal, galaxy=galaxy, radius=radius, survey=survey,
                                  pixscale=args.pixscale, nproc=args.nproc, force=args.force)
            if err == 0:
                print('ERROR: {}; please check the logfile.'.format(galaxy), flush=True)
            print('Finished galaxy {} in {:.3f} minutes.'.format(
                galaxy, (time.time() - t0) / 60), flush=True)

    if args.custom_coadds:
        from legacyhalos.coadds import custom_coadds
        survey = LegacySurveyData()

        for ii in groups:
            t0 = time.time()

            onegal = sample[ii][0]
            galaxy = onegal['GALAXY'].lower()

            survey.output_dir = os.path.join(analysisdir, galaxy)
            survey.ccds = fits_table(os.path.join(survey.output_dir, '{}-ccds.fits'.format(galaxy)))

            radius = legacyhalos.misc.cutout_radius_150kpc( 
                redshift=onegal['Z'], pixscale=args.pixscale) # [pixels]
            
            err = custom_coadds(onegal, galaxy=galaxy, radius=radius, survey=survey,
                                pixscale=args.pixscale, nproc=args.nproc, verbose=args.verbose)
            if err == 0:
                print('ERROR: {}; please check the logfile.'.format(galaxy), flush=True)
            print('Finished galaxy {} in {:.3f} minutes.'.format(
                galaxy, (time.time() - t0) / 60), flush=True)

    if args.ellipse:
        from legacyhalos.ellipse import legacyhalos_ellipse

        for ii in groups:
            t0 = time.time()

            onegal = sample[ii][0]
            galaxy = onegal['GALAXY'].lower()
            galaxydir = os.path.join(analysisdir, galaxy)

            err = legacyhalos_ellipse(onegal, galaxydir=galaxydir, pixscale=args.pixscale, 
                                      verbose=args.verbose)
            if err == 0:
                print('ERROR: {}; please check the logfile.'.format(galaxy), flush=True)
            print('Finished galaxy {} in {:.3f} minutes.'.format(
                galaxy, (time.time() - t0) / 60), flush=True)

    if args.html:
        from legacyhalos.html import make_plots
        survey = LegacySurveyData()

        htmldir = os.path.join(analysisdir, 'html')

        for ii in groups:
            t0 = time.time()

            onegal = sample[ii][0]
            galaxy = onegal['GALAXY'].lower()

            survey.output_dir = os.path.join(analysisdir, galaxy)
            survey.ccds = fits_table(os.path.join(survey.output_dir, '{}-ccds.fits'.format(galaxy)))
            
            err = make_plots([onegal], galaxylist=[galaxy], analysisdir=analysisdir,
                             htmldir=htmldir, clobber=args.clobber, verbose=args.verbose,
                             survey=survey, nproc=args.nproc, pixscale=args.pixscale,
                             ccdqa=True, trends=False)
            if err == 0:
                print('ERROR: {}; please check the logfile.'.format(galaxy), flush=True)
            print('Finished galaxy {} in {:.3f} minutes.'.format(
                galaxy, (time.time() - t0) / 60), flush=True)
            
if __name__ == '__main__':
    main()

