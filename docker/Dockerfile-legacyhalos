# Starting from the legacypipe-nersc docker container, customize our build.  Be sure to do
#   docker login
#   docker pull legacysurvey/legacypipe:latest
# before building and pushing the container with
#   docker build . -t flagnarg/legacyhalos --file Dockerfile-legacyhalos
#   docker push flagnarg/legacyhalos:latest
# Finally, run this container with:
#   docker run -it flagnarg/legacyhalos:latest

FROM legacysurvey/legacypipe:latest

# pip-install what we need
RUN for x in \
    healpy \
    seaborn \
    ; do pip3 install $x; done \
    && rm -Rf /root/.cache/pip

RUN pip3 install --no-cache-dir ipython
    
# Add the development version of photutils.
RUN mkdir -p /src \
    && git clone https://github.com/astropy/photutils.git \
    && cd photutils \
    && python3 setup.py install

# Create a fake home directory so that packages can create config files if
# needed.
RUN mkdir -p /home/legacyhalos \
    /home/legacyhalos/.astropy
    
ENV HOME /home/legacyhalos
RUN python -c "import astropy" \
    python -c "import matplotlib.font_manager as fm; f = fm.FontManager" \
    ipython

# Set prompt and default shell
SHELL ["/bin/bash", "-c"]
RUN echo "export PS1='[docker-legacyhalos] \\u@\\h:\\w$ '" >> /root/.bashrc

ENTRYPOINT ["/bin/bash", "-c"]
CMD ["/bin/bash"]

# Set up some final environment variables
ENV PYTHONPATH /usr/local/lib/python

RUN rm /root/.profile
RUN cd
